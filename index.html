<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETSI 규격 매니저 (Ultra Stable)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root { --primary-color: #2563eb; --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
        body { font-family: 'Inter', sans-serif; background: var(--bg-gradient); min-height: 100vh; padding: 2rem 0; color: #1f2937; }
        .main-card { background: white; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); overflow: hidden; max-width: 1000px; margin: 0 auto; }
        .nav-pills { background: #f1f5f9; padding: 0.5rem; border-radius: 16px; margin: 2rem 2rem 0 2rem; display: inline-flex; }
        .nav-pills .nav-link { border-radius: 12px; color: #64748b; font-weight: 600; padding: 0.75rem 1.5rem; transition: all 0.2s; }
        .nav-pills .nav-link.active { background-color: white; color: var(--primary-color); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tab-content { padding: 2rem; }
        .single-search-box { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 16px; padding: 2rem; text-align: center; }
        .form-control-lg { border-radius: 12px; border: 2px solid #cbd5e1; font-size: 1rem; padding: 0.8rem 1rem; }
        .form-control-lg:focus { border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        .upload-area { border: 2px dashed #cbd5e1; border-radius: 16px; padding: 3rem; text-align: center; cursor: pointer; transition: all 0.2s; background: #f8fafc; }
        .upload-area:hover { border-color: var(--primary-color); background: #eff6ff; }
        .result-group { margin-top: 1.5rem; border: 1px solid #e2e8f0; border-radius: 16px; overflow: hidden; background: white; animation: slideUp 0.3s ease-out; }
        .result-header { padding: 0.8rem 1.5rem; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; font-weight: 700; color: #334155; font-size: 0.95rem; }
        .table th { background: #f8fafc; text-transform: uppercase; font-size: 0.8rem; color: #64748b; font-weight: 600; text-align: center; }
        .table td { vertical-align: middle; text-align: center; }
        .status-badge { font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
        .bg-ok { background: #dcfce7; color: #166534; }
        .bg-update { background: #fee2e2; color: #991b1b; }
        .bg-wait { background: #f1f5f9; color: #64748b; }
        .col-pub { border-top: 3px solid #10b981; }
        .col-final { border-top: 3px solid #f59e0b; }
        .col-draft { border-top: 3px solid #9ca3af; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-4">
        <h1 class="fw-bold text-dark mb-2">ETSI Standards Manager</h1>
        <p class="text-secondary">Ultra Stable Mode: 안정성을 위해 속도를 늦추고 재시도 횟수를 늘렸습니다.</p>
    </div>

    <div class="main-card">
        <div class="text-center">
            <ul class="nav nav-pills" id="pills-tab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="tab-single" data-bs-toggle="pill" data-bs-target="#content-single">
                        <i class="bi bi-search me-2"></i>개별 검색
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tab-batch" data-bs-toggle="pill" data-bs-target="#content-batch">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>엑셀 일괄 비교
                    </button>
                </li>
            </ul>
        </div>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="content-single">
                <div class="single-search-box">
                    <div class="row g-3 justify-content-center">
                        <div class="col-md-5">
                            <label class="form-label fw-bold text-secondary small">규격 번호</label>
                            <input type="text" id="inputNo" class="form-control form-control-lg" placeholder="예: 300 440-1" onkeypress="handleEnter(event)">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold text-secondary small">내 버전 (선택)</label>
                            <input type="text" id="inputMyVer" class="form-control form-control-lg" placeholder="예: V2.1.1">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary btn-lg w-100" onclick="runSingleSearch()">
                                <i class="bi bi-search"></i> 조회
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="loaderSingle" class="text-center mt-4" style="display:none;">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2 text-muted small">안정적으로 데이터 수집 중...</div>
                </div>
                
                <div id="singleResultsContainer"></div>
                <div id="errorSingle" class="alert alert-danger mt-3 text-center" style="display:none;"></div>
            </div>

            <div class="tab-pane fade" id="content-batch">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <i class="bi bi-cloud-upload text-primary" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 fw-bold">엑셀 파일 업로드</h5>
                    <p class="text-secondary small mb-0">I열 데이터 인식 (안정화 모드 적용)</p>
                    <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;" onchange="handleFile(this)">
                </div>

                <div id="filterMsg" class="alert alert-info mt-3 text-center small" style="display:none;"></div>
                <div class="progress mt-3" id="progressContainer" style="height: 10px; display:none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" style="width: 0%"></div>
                </div>

                <div class="table-responsive mt-4" id="batchResultArea" style="display:none;">
                    <table class="table table-hover align-middle border">
                        <thead>
                            <tr>
                                <th>규격 번호</th>
                                <th>내 버전</th>
                                <th>ETSI 최신 (Pub)</th>
                                <th>상태</th>
                                <th>링크</th>
                            </tr>
                        </thead>
                        <tbody id="batchBody"></tbody>
                    </table>
                </div>
                <div class="text-center mt-4">
                    <button onclick="exportToExcel()" class="btn btn-success" id="btnExport" style="display:none;">
                        <i class="bi bi-download me-2"></i>결과 다운로드
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const PROXY_URL = "https://api.allorigins.win/get?url=";
    const ETSI_BASE = "https://www.etsi.org/deliver/etsi_en";
    let batchData = [];

    function handleEnter(e) { if (e.key === 'Enter') runSingleSearch(); }

    // ==========================================
    // [설정 강화] 재시도 횟수 및 대기 시간 증가
    // ==========================================
    const RETRY_COUNT = 5;      // 재시도 5회 (기존 3회)
    const RETRY_DELAY = 3000;   // 재시도 사이 3초 대기 (기존 1초)
    const BATCH_INTERVAL = 2500;// 배치 처리 간격 2.5초 (기존 1초)

    async function fetchWithRetry(url) {
        for (let i = 0; i < RETRY_COUNT; i++) {
            try {
                // 타임아웃 추가 (10초 이상 응답 없으면 끊고 재시도)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(PROXY_URL + encodeURIComponent(url), {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const json = await response.json();
                if (json.contents) return json;
                throw new Error("Empty contents");
            } catch (err) {
                console.warn(`Attempt ${i+1} failed for ${url}. Retrying in ${RETRY_DELAY/1000}s...`);
                if (i === RETRY_COUNT - 1) throw err;
                await new Promise(res => setTimeout(res, RETRY_DELAY));
            }
        }
    }

    async function resolveTargetUrl(input) {
        const clean = input.trim();
        const results = [];

        let main = "", part = "";
        let isSpecific = false;

        if (clean.includes("-")) {
            const parts = clean.split("-");
            main = parts[0].replace(/[^0-9]/g, "");
            part = parts[1].replace(/[^0-9]/g, "");
            if (part.length === 1) part = "0" + part; 
            isSpecific = true;
        } else {
            main = clean.replace(/[^0-9]/g, "");
        }

        const directId = main + part; 
        
        let prefix = directId.substring(0, 4);
        if(directId.length < 4) prefix = directId.padEnd(4, '0');
        const rangeStart = parseInt(prefix + "00");
        const rangeFolder = `${rangeStart}_${rangeStart + 99}`;
        const rangeUrl = `${ETSI_BASE}/${rangeFolder}/`;

        if (isSpecific) {
            const directUrl = `${rangeUrl}${directId}/`;
            try {
                const json = await fetchWithRetry(directUrl);
                if (json.contents && json.contents.includes("DIR")) {
                    return [{ name: directId, url: directUrl }];
                }
            } catch (e) {
                console.log("Direct access failed, switching to discovery...");
            }
        }

        try {
            const json = await fetchWithRetry(rangeUrl);
            const parser = new DOMParser();
            const doc = parser.parseFromString(json.contents, "text/html");
            const links = doc.querySelectorAll('a');

            links.forEach(link => {
                let folderName = link.textContent.trim().replace(/\//g, "");
                const searchKey = isSpecific ? directId : main;
                
                if (folderName.startsWith(searchKey) && /^\d+$/.test(folderName)) {
                    if (isSpecific && folderName !== directId) return;
                    results.push({ name: folderName, url: `${rangeUrl}${folderName}/` });
                }
            });
        } catch (e) { console.error(e); }

        return results;
    }

    // ==========================================
    // 1. 개별 검색
    // ==========================================
    async function runSingleSearch() {
        const input = document.getElementById('inputNo').value.trim();
        const myVer = document.getElementById('inputMyVer').value.trim();
        const container = document.getElementById('singleResultsContainer');
        
        if (input.length < 3) return alert("규격 번호를 입력해주세요.");

        document.getElementById('loaderSingle').style.display = 'block';
        container.innerHTML = '';
        document.getElementById('errorSingle').style.display = 'none';

        try {
            const targetFolders = await resolveTargetUrl(input);
            if (targetFolders.length === 0) throw new Error("Standards not found");

            const promises = targetFolders.map(folder => processSingleFolder(folder, myVer));
            const results = await Promise.all(promises);
            
            results.forEach(html => {
                if(html) container.insertAdjacentHTML('beforeend', html);
            });
            
            if (container.innerHTML === '') throw new Error("No version data found");

        } catch (err) {
            document.getElementById('errorSingle').innerText = "규격 정보를 가져올 수 없습니다. 잠시 후 다시 시도해주세요.";
            document.getElementById('errorSingle').style.display = 'block';
        } finally {
            document.getElementById('loaderSingle').style.display = 'none';
        }
    }

    async function processSingleFolder(folderObj, myVer) {
        try {
            const json = await fetchWithRetry(folderObj.url);
            const result = parseEtsiHtml(json.contents, folderObj.url);
            if (!result.found) return null;
            return createResultCard(folderObj.name, result.best, myVer);
        } catch(e) { return null; }
    }

    function createResultCard(stdNumRaw, best, myVer) {
        const title = formatTitleFromRaw(stdNumRaw);
        let badgeHtml = '';
        if (myVer && best.pub) {
            const etsiVer = best.pub.ver;
            if (etsiVer === myVer) badgeHtml = '<span class="status-badge bg-ok">최신 버전</span>';
            else if (compareVersions(etsiVer, myVer)) badgeHtml = '<span class="status-badge bg-update">업데이트 필요</span>';
            else badgeHtml = '<span class="status-badge bg-wait">버전 확인</span>';
        }

        return `
        <div class="result-group">
            <div class="result-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-folder2-open me-2"></i>${title}</span>
                ${badgeHtml}
            </div>
            <div class="table-responsive">
                <table class="table mb-0">
                    <thead>
                        <tr><th class="col-pub">Publication (_60)</th><th class="col-final">Final Draft (_30)</th><th class="col-draft">Draft (_20)</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>${renderCell(best.pub)}</td><td>${renderCell(best.final)}</td><td>${renderCell(best.draft)}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>`;
    }

    function renderCell(data) {
        if (!data) return '<span class="text-black-50 py-2 d-block">-</span>';
        return `<div class="py-2"><span class="d-block fw-bold text-dark">${data.ver}</span><span class="d-block text-secondary small mb-1">${data.date}</span><a href="${data.link}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill px-3 py-0" style="font-size:0.75rem;">PDF</a></div>`;
    }

    // ==========================================
    // 2. 엑셀 일괄 비교
    // ==========================================
    function handleFile(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            processBatch(rows);
        };
        reader.readAsArrayBuffer(file);
    }

    async function processBatch(rows) {
        const batchBody = document.getElementById('batchBody');
        batchBody.innerHTML = '';
        batchData = [];

        const rawTargets = [];
        rows.forEach((row, idx) => {
            if (idx < 1) return;
            const txt = row[8];
            if (typeof txt === 'string' && txt.includes("ETSI")) {
                const match = txt.match(/ETSI\s+EN\s+([\d\s-]+)\s+(V\d+\.\d+\.\d+)/i);
                if (match) rawTargets.push({ id: idx, std: match[1].trim(), ver: match[2].trim() });
            }
        });

        if (rawTargets.length === 0) return alert("데이터 없음");

        const filteredMap = new Map();
        rawTargets.forEach(item => {
            const key = item.std.replace(/\s+/g, "");
            if (!filteredMap.has(key) || compareVersions(item.ver, filteredMap.get(key).ver)) {
                filteredMap.set(key, item);
            }
        });
        
        let targets = Array.from(filteredMap.values());
        targets.sort((a, b) => {
            const numA = a.std.replace(/[^0-9]/g, "");
            const numB = b.std.replace(/[^0-9]/g, "");
            return numA.localeCompare(numB, undefined, { numeric: true });
        });

        document.getElementById('filterMsg').innerText = `총 ${rawTargets.length}건 중 ${targets.length}건 검사 진행 (예상 소요시간: ${Math.round(targets.length * 3)}초)`;
        document.getElementById('filterMsg').style.display = 'block';
        document.getElementById('batchResultArea').style.display = 'block';
        document.getElementById('progressContainer').style.display = 'flex';
        document.getElementById('btnExport').style.display = 'none';

        const etsiCache = new Map();

        for (let i = 0; i < targets.length; i++) {
            const item = targets[i];
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.std}</td><td>${item.ver}</td><td><div class="spinner-border spinner-border-sm text-secondary"></div></td><td><span class="status-badge bg-wait">대기</span></td><td></td>`;
            batchBody.appendChild(tr);

            const cacheKey = item.std.replace(/\s+/g, "");
            let etsiRes = null;

            if (etsiCache.has(cacheKey)) {
                etsiRes = etsiCache.get(cacheKey);
                await new Promise(r => setTimeout(r, 100)); // 캐시 사용 시 짧은 대기
            } else {
                const foundFolders = await resolveTargetUrl(item.std);
                
                if (foundFolders.length > 0) {
                    const targetFolder = foundFolders[0]; 
                    try {
                        const json = await fetchWithRetry(targetFolder.url);
                        const parsed = parseEtsiHtml(json.contents, targetFolder.url);
                        if(parsed.found && parsed.best.pub) etsiRes = parsed.best.pub;
                    } catch(e) {}
                }
                etsiCache.set(cacheKey, etsiRes);
                // 안정성을 위해 요청 간격 증가 (BATCH_INTERVAL)
                await new Promise(r => setTimeout(r, BATCH_INTERVAL));
            }

            updateBatchRow(tr, item, etsiRes);
            const pct = Math.round(((i+1)/targets.length)*100);
            document.getElementById('progressBar').style.width = pct + "%";
        }
        
        document.getElementById('btnExport').style.display = 'inline-block';
        document.getElementById('progressBar').classList.remove('progress-bar-animated');
    }

    function updateBatchRow(tr, item, etsi) {
        let etsiHtml = '<span class="text-danger small">Not Found</span>';
        let statusHtml = '<span class="bg-wait status-badge">확인불가</span>';
        let linkHtml = '';

        if (etsi) {
            etsiHtml = `<strong>${etsi.ver}</strong><br><span class="small text-muted">${etsi.date}</span>`;
            linkHtml = `<a href="${etsi.link}" target="_blank" class="btn btn-sm btn-light border"><i class="bi bi-box-arrow-up-right"></i></a>`;
            if (etsi.ver === item.ver) statusHtml = '<span class="bg-ok status-badge">최신</span>';
            else if (compareVersions(etsi.ver, item.ver)) statusHtml = '<span class="bg-update status-badge">업데이트!</span>';
            else statusHtml = '<span class="bg-wait status-badge">버전확인</span>';
            
            batchData.push({ "규격": item.std, "보유": item.ver, "최신": etsi.ver, "상태": (etsi.ver===item.ver?"OK":"Update"), "링크": etsi.link });
        } else {
            batchData.push({ "규격": item.std, "보유": item.ver, "최신": "Not Found", "상태": "Error" });
        }
        tr.innerHTML = `<td>${item.std}</td><td>${item.ver}</td><td>${etsiHtml}</td><td>${statusHtml}</td><td>${linkHtml}</td>`;
    }

    function parseEtsiHtml(html, baseUrl) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const links = doc.querySelectorAll('a');
        let best = { pub: null, final: null, draft: null };
        let found = false;

        links.forEach(link => {
            const name = link.textContent.trim();
            const match = name.match(/(\d+\.\d+\.\d+)_(\d+)/);
            if (match) {
                found = true;
                const verRaw = match[1];
                const sfx = match[2];
                const cleanVer = "V" + verRaw.split('.').map(n=>parseInt(n)).join('.');
                let date = "-";
                let node = link.previousSibling;
                for(let k=0; k<3; k++) {
                    if(!node) break;
                    const txt = node.textContent || "";
                    const dm = txt.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
                    if(dm) { date = formatDate(dm[1]); break; }
                    node = node.previousSibling;
                }
                const item = { ver: cleanVer, raw: verRaw, date: date, link: baseUrl + name + "/" };
                if(sfx==='60') updateBest(best, 'pub', item);
                else if(sfx==='30') updateBest(best, 'final', item);
                else if(sfx==='20') updateBest(best, 'draft', item);
            }
        });
        return { found, best };
    }

    function formatTitleFromRaw(raw) {
        if (raw.length === 8) {
            const main = raw.substring(0, 6);
            const sub = parseInt(raw.substring(6, 8)); 
            return `ETSI EN ${main.substring(0,3)} ${main.substring(3)} - ${sub}`;
        } else if (raw.length === 6) {
            return `ETSI EN ${raw.substring(0,3)} ${raw.substring(3)}`;
        }
        return "ETSI EN " + raw;
    }

    function formatDate(d) {
        const p = d.split('/');
        if(p.length===3) return `${p[2]}/${p[0].padStart(2,'0')}/${p[1].padStart(2,'0')}`;
        return d;
    }

    function updateBest(store, key, item) {
        if (!store[key] || item.raw.localeCompare(store[key].raw, undefined, {numeric:true}) > 0) store[key] = item;
    }

    function compareVersions(v1, v2) {
        const p1 = v1.replace(/[^0-9.]/g,'').split('.').map(Number);
        const p2 = v2.replace(/[^0-9.]/g,'').split('.').map(Number);
        for(let i=0; i<Math.max(p1.length,p2.length); i++) {
            const n1=p1[i]||0, n2=p2[i]||0;
            if(n1>n2) return true; if(n1<n2) return false;
        }
        return false;
    }

    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(batchData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Result");
        XLSX.writeFile(wb, "ETSI_Comparison.xlsx");
    }
</script>
</body>
</html>
