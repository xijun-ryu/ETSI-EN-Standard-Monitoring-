<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETSI 실시간 규격 조회</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding-top: 50px; }
        .search-box { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .table th { text-align: center; vertical-align: middle; background-color: #343a40; color: white; }
        .ver-text { font-weight: bold; font-size: 1.1rem; display: block; }
        .date-text { font-size: 0.85rem; color: #666; }
        .loading-spinner { display: none; }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="search-box text-center mb-5">
            <h2 class="fw-bold mb-3">ETSI Live Search</h2>
            <p class="text-muted mb-4">규격 번호를 입력하면 ETSI 서버를 실시간으로 조회합니다.</p>
            
            <div class="input-group input-group-lg">
                <input type="text" id="inputNo" class="form-control" placeholder="예: 301 893" onkeypress="handleEnter(event)">
                <button class="btn btn-primary px-4" onclick="runSearch()">검색</button>
            </div>
            
            <div id="loader" class="mt-3 loading-spinner">
                <div class="spinner-border text-primary" role="status"></div>
                <span class="ms-2">ETSI 서버 접속 중...</span>
            </div>
        </div>

        <div id="resultArea" class="card border-0 shadow-sm" style="display:none;">
            <div class="card-body p-0">
                <table class="table table-bordered mb-0 align-middle">
                    <thead>
                        <tr>
                            <th width="20%">규격 번호</th>
                            <th width="26%" class="bg-success bg-opacity-75">Publication (_60)</th>
                            <th width="27%" class="bg-warning bg-opacity-75 text-dark">Final Draft (_30)</th>
                            <th width="27%" class="bg-secondary bg-opacity-75">Draft (_20)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-center fw-bold fs-4 text-primary" id="resTitle">-</td>
                            <td id="cellPub">-</td>
                            <td id="cellFinal">-</td>
                            <td id="cellDraft">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="errorMsg" class="alert alert-danger text-center mt-3" style="display:none;"></div>

    </div>

    <script>
        // 프록시 서버 (CORS 우회용)
        const PROXY_URL = "https://api.allorigins.win/get?url=";
        const ETSI_BASE = "https://www.etsi.org/deliver/etsi_en";

        function handleEnter(e) {
            if (e.key === 'Enter') runSearch();
        }

        async function runSearch() {
            const input = document.getElementById('inputNo').value;
            const cleanNum = input.replace(/[^0-9]/g, ""); // 숫자만 추출

            if (cleanNum.length < 4) {
                alert("정확한 규격 번호를 입력해주세요.");
                return;
            }

            // UI 초기화
            document.getElementById('loader').style.display = 'block';
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'none';

            // 1. URL 계산 (예: 301893 -> 301800_301899 폴더)
            const startRange = Math.floor(parseInt(cleanNum) / 100) * 100;
            const folderRange = `${startRange}_${startRange + 99}`;
            const targetUrl = `${ETSI_BASE}/${folderRange}/${cleanNum}/`;
            
            // 2. 프록시를 통해 요청
            try {
                const response = await fetch(PROXY_URL + encodeURIComponent(targetUrl));
                const json = await response.json();
                
                if (!json.contents) throw new Error("데이터를 가져올 수 없습니다.");

                const html = json.contents;
                parseAndDisplay(html, cleanNum, targetUrl);

            } catch (err) {
                showError("해당 규격을 찾을 수 없거나 서버 응답이 없습니다.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function parseAndDisplay(html, stdNum, baseUrl) {
            // HTML 파싱을 위한 임시 엘리먼트
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const links = doc.querySelectorAll('a');

            // 저장소
            let best = { pub: null, final: null, draft: null };
            let foundAny = false;

            // 정규식: 날짜 찾기 (MM/DD/YYYY)
            // HTML 텍스트 전체에서 줄 단위로 날짜를 매칭하기 위해 원본 텍스트 사용
            const textLines = html.split('\n');

            links.forEach(link => {
                const href = link.getAttribute('href');
                const folderName = link.textContent.trim();

                // 버전 폴더 패턴 (예: 1.2.1_60)
                const match = folderName.match(/(\d+\.\d+\.\d+)_(\d+)/);
                
                if (match && href && !href.startsWith('?')) {
                    foundAny = true;
                    const verRaw = match[1];
                    const suffix = match[2]; // 60, 30, 20
                    const cleanVer = "V" + verRaw.split('.').map(n => parseInt(n)).join('.');
                    
                    // 날짜 찾기: 해당 폴더명이 포함된 텍스트 줄을 찾음
                    let date = "-";
                    for(let line of textLines) {
                        if(line.includes(folderName)) {
                            const dateMatch = line.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
                            if(dateMatch) {
                                date = dateMatch[1];
                                break;
                            }
                        }
                    }

                    const item = {
                        ver: cleanVer,
                        raw: verRaw,
                        date: date,
                        link: new URL(href, baseUrl).href
                    };

                    // 최신 버전 비교 및 저장
                    if (suffix === '60') updateBest(best, 'pub', item);
                    else if (suffix === '30') updateBest(best, 'final', item);
                    else if (suffix === '20') updateBest(best, 'draft', item);
                }
            });

            if (!foundAny) {
                showError("폴더는 존재하지만 버전 정보를 찾을 수 없습니다.");
                return;
            }

            // 결과 화면 표시
            document.getElementById('resTitle').innerText = inputDisplayFormat(stdNum);
            
            drawCell('cellPub', best.pub, 'success');
            drawCell('cellFinal', best.final, 'warning');
            drawCell('cellDraft', best.draft, '');

            document.getElementById('resultArea').style.display = 'block';
        }

        function updateBest(store, key, newItem) {
            // 더 높은 버전이면 교체
            if (!store[key] || newItem.raw.localeCompare(store[key].raw, undefined, { numeric: true }) > 0) {
                store[key] = newItem;
            }
        }

        function drawCell(elementId, data, color) {
            const el = document.getElementById(elementId);
            if (!data) {
                el.innerHTML = '<span class="text-muted text-center d-block">-</span>';
                el.className = ''; // 배경색 제거
            } else {
                el.className = color ? 'table-' + color : '';
                el.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-start">
                            <span class="ver-text">${data.ver}</span>
                            <span class="date-text">${data.date}</span>
                        </div>
                        <a href="${data.link}" target="_blank" class="btn btn-sm btn-outline-dark bg-white">Open</a>
                    </div>
                `;
            }
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.innerText = msg;
            el.style.display = 'block';
        }

        function inputDisplayFormat(num) {
            // 301893 -> 301 893
            if(num.length > 3) return num.slice(0,3) + " " + num.slice(3);
            return num;
        }
    </script>
</body>
</html>
