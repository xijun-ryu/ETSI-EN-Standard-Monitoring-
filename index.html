<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETSI 규격 버전 관리자</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 2rem 0;
            color: #1f2937;
        }
        .main-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 1000px;
            margin: 0 auto;
        }
        .card-header {
            background: #1e293b;
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin: 2rem;
            transition: all 0.2s;
            cursor: pointer;
            background: #f8fafc;
        }
        .upload-area:hover {
            border-color: var(--primary-color);
            background: #eff6ff;
        }
        .status-badge {
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
        }
        .status-update { background: #fee2e2; color: #991b1b; } /* 업데이트 필요 */
        .status-ok { background: #dcfce7; color: #166534; }    /* 최신 */
        .status-wait { background: #f1f5f9; color: #64748b; }  /* 대기중 */
        
        .progress { height: 8px; margin: 0 2rem 2rem 2rem; display: none; }
        .table-responsive { margin: 0 2rem 2rem 2rem; }
        .table th { font-size: 0.85rem; text-transform: uppercase; color: #64748b; background: #f8fafc; }
        .table td { vertical-align: middle; }
    </style>
</head>
<body>

    <div class="container">
        <div class="main-card">
            <div class="card-header">
                <h2 class="fw-bold mb-0">ETSI Batch Checker</h2>
                <p class="text-white-50 mb-0 mt-2">엑셀 파일을 업로드하면 I열의 규격을 분석하여 최신 버전과 비교합니다.</p>
            </div>

            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-cloud-arrow-up-fill text-primary" style="font-size: 3rem;"></i>
                <h4 class="mt-3 fw-bold">Click to Upload Excel File</h4>
                <p class="text-secondary">.xlsx or .xls files</p>
                <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;" onchange="handleFile(this)">
            </div>

            <div class="progress" id="progressBarContainer">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" style="width: 0%"></div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="20%">규격 번호</th>
                            <th width="15%">보유 버전 (Excel)</th>
                            <th width="15%">최신 발행본 (ETSI)</th>
                            <th width="15%">상태</th>
                            <th width="20%">비고</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody">
                        </tbody>
                </table>
            </div>
            
            <div class="text-center mb-4">
                 <button onclick="exportToExcel()" class="btn btn-success px-4" id="btnExport" style="display:none;">
                    <i class="bi bi-file-earmark-excel"></i> 결과 엑셀 저장
                </button>
            </div>
        </div>
    </div>

    <script>
        const PROXY_URL = "https://api.allorigins.win/get?url=";
        const ETSI_BASE = "https://www.etsi.org/deliver/etsi_en";
        let resultsData = [];

        // 1. 엑셀 파일 읽기
        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // 시트 데이터를 JSON으로 변환 (헤더 없이 배열의 배열로)
                const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                processRows(rows);
            };
            reader.readAsArrayBuffer(file);
        }

        // 2. 데이터 처리 및 순차 실행
        async function processRows(rows) {
            const resultBody = document.getElementById('resultBody');
            resultBody.innerHTML = '';
            resultsData = [];
            
            const targetList = [];

            // I열(인덱스 8) 읽기
            rows.forEach((row, index) => {
                if (index < 1) return; // 헤더(첫 줄) 건너뛰기 (필요시 조절)
                const cellData = row[8]; // I열 = 인덱스 8

                if (cellData && typeof cellData === 'string' && cellData.includes("ETSI")) {
                    // 파싱: "ETSI EN 300 330-2 V1.6.1:2015"
                    // 정규식으로 규격번호와 버전 추출
                    // Group 1: 300 330-2
                    // Group 2: V1.6.1
                    const match = cellData.match(/ETSI\s+EN\s+([\d\s-]+)\s+(V\d+\.\d+\.\d+)/i);
                    
                    if (match) {
                        targetList.push({
                            id: index,
                            original: cellData,
                            stdNum: match[1].trim(), // "300 330-2"
                            myVer: match[2].trim()   // "V1.6.1"
                        });
                    }
                }
            });

            if (targetList.length === 0) {
                alert("I열에서 'ETSI EN...' 형식의 데이터를 찾을 수 없습니다.");
                return;
            }

            // UI 준비
            document.getElementById('progressBarContainer').style.display = 'flex';
            document.getElementById('btnExport').style.display = 'none';
            const progressBar = document.getElementById('progressBar');
            
            // 순차 처리 (Rate Limit 방지용 delay)
            for (let i = 0; i < targetList.length; i++) {
                const item = targetList[i];
                
                // 테이블에 '대기중' 행 추가
                addPendingRow(item);

                // ETSI 조회
                const etsiData = await fetchEtsiData(item.stdNum);
                
                // 결과 분석 및 UI 업데이트
                updateRow(item, etsiData);

                // 진행률 업데이트
                const percent = Math.round(((i + 1) / targetList.length) * 100);
                progressBar.style.width = percent + "%";
                progressBar.innerText = percent + "%";

                // 0.5초 대기 (서버 부하 방지)
                await new Promise(r => setTimeout(r, 500));
            }

            document.getElementById('btnExport').style.display = 'inline-block';
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-success');
            progressBar.innerText = "완료!";
        }

        // 3. ETSI 데이터 가져오기 (기존 검색 로직 재활용)
        async function fetchEtsiData(stdNumInput) {
            try {
                // "300 330-2" -> "300330", "02"
                const cleanInput = stdNumInput.replace(/\s+/g, ""); 
                let mainNum = cleanInput;
                let partNum = "";

                if (cleanInput.includes("-")) {
                    const parts = cleanInput.split("-");
                    mainNum = parts[0];     
                    partNum = parts[1];     
                    if (partNum.length === 1) partNum = "0" + partNum; 
                }

                let targetFolder = partNum ? (mainNum + partNum) : mainNum;
                let rangePrefix = targetFolder.substring(0, targetFolder.length >= 6 ? 4 : 3);
                let rangeStart = parseInt(rangePrefix + "00");
                if (targetFolder.length < 5) rangeStart = Math.floor(parseInt(targetFolder) / 100) * 100;

                const rangeFolder = `${rangeStart}_${rangeStart + 99}`;
                const fullUrl = `${ETSI_BASE}/${rangeFolder}/${targetFolder}/`;

                const response = await fetch(PROXY_URL + encodeURIComponent(fullUrl));
                const json = await response.json();
                
                if (!json.contents) return null;
                
                return parseLatestPub(json.contents, fullUrl);

            } catch (e) {
                console.error(e);
                return null;
            }
        }

        // 4. 최신 Publication 버전 찾기
        function parseLatestPub(html, baseUrl) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const links = doc.querySelectorAll('a');
            
            let bestPub = null;

            links.forEach(link => {
                const folderName = link.textContent.trim();
                const match = folderName.match(/(\d+\.\d+\.\d+)_(\d+)/);
                
                if (match) {
                    const verRaw = match[1];
                    const suffix = match[2];
                    
                    // Publication(_60)만 체크
                    if (suffix === '60') {
                        const cleanVer = "V" + verRaw.split('.').map(n => parseInt(n)).join('.');
                        
                        // 날짜 찾기
                        let date = "-";
                        let checkNode = link.previousSibling;
                        for(let i=0; i<3; i++) {
                            if(!checkNode) break;
                            const text = checkNode.textContent || "";
                            const dateMatch = text.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
                            if (dateMatch) {
                                date = dateMatch[1]; // MM/DD/YYYY
                                break;
                            }
                            checkNode = checkNode.previousSibling;
                        }

                        const item = {
                            ver: cleanVer, // V2.1.1
                            raw: verRaw,   // 02.01.01
                            date: date,
                            link: baseUrl + folderName + "/"
                        };

                        if (!bestPub || verRaw.localeCompare(bestPub.raw, undefined, { numeric: true }) > 0) {
                            bestPub = item;
                        }
                    }
                }
            });
            return bestPub;
        }

        // 5. UI 관련 함수들
        function addPendingRow(item) {
            const tbody = document.getElementById('resultBody');
            const row = document.createElement('tr');
            row.id = `row-${item.id}`;
            row.innerHTML = `
                <td>${item.id}</td>
                <td class="fw-bold">${item.stdNum}</td>
                <td>${item.myVer}</td>
                <td><div class="spinner-border spinner-border-sm text-primary"></div></td>
                <td><span class="status-badge status-wait">조회중...</span></td>
                <td></td>
            `;
            tbody.appendChild(row);
        }

        function updateRow(item, etsiData) {
            const row = document.getElementById(`row-${item.id}`);
            if (!row) return;

            let latestVer = "N/A";
            let statusBadge = '<span class="status-badge status-wait">Not Found</span>';
            let remark = "";
            let linkHtml = "";

            if (etsiData) {
                latestVer = `${etsiData.ver}<br><small class="text-muted">${etsiData.date}</small>`;
                linkHtml = `<a href="${etsiData.link}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-box-arrow-up-right"></i> Open</a>`;
                
                // 버전 비교
                // 단순 문자열 비교로는 V1.10.1 < V1.2.1로 잘못될 수 있으므로 숫자 분리 비교 필요하지만,
                // 여기선 간단히 raw 값(02.01.01)이 있으면 그것을 쓰는 게 정확함.
                // item.myVer(V1.6.1) -> 01.06.01로 변환 필요하지만 복잡하므로
                // ETSI가 제공하는 raw값 비교가 불가능하니, 문자열 자연 정렬 비교 사용
                
                const isNewer = compareVersions(etsiData.ver, item.myVer); // etsi > my

                if (etsiData.ver === item.myVer) {
                    statusBadge = '<span class="status-badge status-ok">최신 (OK)</span>';
                } else if (isNewer) {
                    statusBadge = '<span class="status-badge status-update">업데이트 필요</span>';
                } else {
                    statusBadge = '<span class="status-badge status-wait">확인 필요</span>'; // 내 버전이 더 높거나 이상함
                }
            }

            row.innerHTML = `
                <td>${item.id}</td>
                <td class="fw-bold">${item.stdNum}</td>
                <td>${item.myVer}</td>
                <td>${latestVer}</td>
                <td>${statusBadge}</td>
                <td>${linkHtml}</td>
            `;

            // 엑셀 내보내기용 데이터 저장
            resultsData.push({
                "규격번호": item.stdNum,
                "내 버전": item.myVer,
                "최신 버전": etsiData ? etsiData.ver : "Not Found",
                "발행일": etsiData ? etsiData.date : "-",
                "상태": etsiData ? (etsiData.ver === item.myVer ? "OK" : "Update Required") : "Error",
                "링크": etsiData ? etsiData.link : ""
            });
        }

        // 버전 비교 함수 (V2.1.1 vs V1.6.1) return true if v1 > v2
        function compareVersions(v1, v2) {
            // 숫자만 추출하여 배열로 (2,1,1 vs 1,6,1)
            const p1 = v1.replace(/[^0-9.]/g, '').split('.').map(Number);
            const p2 = v2.replace(/[^0-9.]/g, '').split('.').map(Number);

            for (let i = 0; i < Math.max(p1.length, p2.length); i++) {
                const n1 = p1[i] || 0;
                const n2 = p2[i] || 0;
                if (n1 > n2) return true;
                if (n1 < n2) return false;
            }
            return false;
        }

        // 6. 결과 엑셀 저장
        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(resultsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "검사결과");
            XLSX.writeFile(wb, "ETSI_Check_Result.xlsx");
        }
    </script>
</body>
</html>
